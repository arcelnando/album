<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#0b0f14">
  <title>ğ‘»ğ‘¹ğ‘°ğ‘ªğ‘²ğ‘ºğ‘»ğ‘¬ğ‘¹ ğ‘´ğ‘¬ğ‘´ğ‘¶ğ‘¹ğ’€ â€” Album Foto</title>
  <meta name="description" content="Album foto TRICKSTER MEMORY â€” simpan (lokal), lihat, dan kelola.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --bg: #0b0f14; --card:#0f141b; --muted:#8b9bb0; --accent:#7c3aed; }
    body { font-family: 'Space Grotesk', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; -webkit-tap-highlight-color: transparent; }
    .glass { backdrop-filter: blur(8px); background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.07); }
    .title-text { color: #ffffff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
    .grid-auto { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
    .shadow-soft { box-shadow: 0 10px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.02); }
    .dropzone-dashed { border: 2px dashed rgba(255,255,255,0.12); }
    .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); }
    .modal-content { background-color: var(--card); margin: 10% auto; padding: 20px; border: 1px solid rgba(255,255,255,0.1); width: 300px; border-radius: 12px; }
    .btn-android { padding: 14px 16px; border-radius: 16px; font-size: 16px; touch-action: manipulation; }
    .input-android { padding: 16px; border-radius: 16px; font-size: 16px; min-height: 52px; }
    .select-android { padding: 16px; border-radius: 16px; font-size: 16px; min-height: 52px; }
    
    /* Better touch targets for mobile */
    button, label, input[type="button"], input[type="submit"] {
      min-height: 44px;
      min-width: 44px;
    }
    
    /* Prevent zoom on input focus */
    @media screen and (max-width: 768px) {
      input, select, textarea {
        font-size: 16px !important;
      }
    }
    
    /* Improved scrolling */
    .gallery-grid {
      -webkit-overflow-scrolling: touch;
      padding-bottom: 80px;
    }
    
    /* Bottom navigation bar */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card);
      border-top: 1px solid rgba(255,255,255,0.1);
      padding: 12px;
      z-index: 40;
    }
    
    /* Image error handling */
    .image-error {
      background: linear-gradient(45deg, #2c3e50, #4ca1af);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      text-align: center;
      padding: 10px;
    }

    /* Loading animation */
    .img-loading {
      background: linear-gradient(90deg, #2c3e50 25%, #34495e 50%, #2c3e50 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Empty state */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
      color: var(--muted);
    }
    
    .empty-state svg {
      margin-bottom: 16px;
      opacity: 0.5;
    }
  </style>
</head>
<body class="h-full bg-[var(--bg)] text-white">
  <header class="sticky top-0 z-40 border-b border-white/10 bg-[#0b0f14e6] backdrop-blur">
  <div class="mx-auto max-w-7xl px-4 py-3 flex items-center gap-3">
    <!-- LOGO BARU TARO DI SINI -->
    <div class="w-9 h-9 rounded-2xl bg-white/10 grid place-items-center overflow-hidden">
      <img src="https://i.ibb.co.com/d0GKmhJp/857a4c42-4ca4-494f-96a3-6c89db50666b.jpg" alt="Logo TRICKSTER MEMORY" class="w-full h-full object-cover" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzYiIGhlaWdodD0iMzYiIHZpZXdCb3g9IjAgMCAzNiAzNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjM2IiBoZWlnaHQ9IjM2IiBmaWxsPSIjMkMzRTUwIi8+Cjx0ZXh0IHg9IjE4IiB5PSIyMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+VE08L3RleHQ+Cjwvc3ZnPg=='">
    </div>
    <!-- SAMPAI SINI -->
    
    <div class="flex-1">
      <h1 class="text-xl sm:text-2xl font-bold tracking-wide title-text">ğ‘»ğ‘¹ğ‘°ğ‘ªğ‘²ğ‘ºğ‘»ğ‘¬ğ‘¹ ğ‘´ğ‘¬ğ‘´ğ‘¶ğ‘¹ğ’€</h1>
      <p class="text-xs text-[var(--muted)] hidden sm:block">Album foto modern. Simpan (perangkat Anda) â€¢ Bagikan lokal.</p>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnLoadImgBB" class="px-3 py-2 text-sm rounded-xl bg-green-600 hover:bg-green-500 border border-white/10">Muat ImgBB</button>
      <button id="btnExport" class="px-3 py-2 text-sm rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 hidden sm:block">Ekspor .zip</button>
    </div>
  </div>
</header>
  
  <main class="mx-auto max-w-7xl px-4 pb-24">
    <!-- Toolbar -->
    <section class="mt-6 flex flex-col sm:flex-row gap-3 items-stretch sm:items-center">
      <div class="flex-1 flex items-center gap-2">
        <input id="search" type="search" placeholder="Cari nama atau catatanâ€¦" class="input-android w-full bg-white/5 border border-white/10 outline-none focus:ring-2 focus:ring-violet-500" />
        <select id="sort" class="select-android bg-white/5 border border-white/10 hidden sm:block">
          <option value="newest">Terbaru</option>
          <option value="oldest">Terlama</option>
          <option value="name">Nama (Aâ†’Z)</option>
        </select>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnImport" class="btn-android bg-white/5 hover:bg-white/10 border border-white/10 hidden sm:block">Impor .zip</button>
        <button id="btnClear" class="btn-android bg-white/5 hover:bg-white/10 border border-rose-400/30 text-rose-300">Hapus Semua</button>
      </div>
    </section>

    <!-- Gallery Grid -->
    <section class="mt-6 grid gap-4 grid-auto gallery-grid" id="gallery">
      <!-- Empty state -->
      <div class="empty-state col-span-full">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <h3 class="text-lg font-medium mb-2">Belum ada foto</h3>
        <p class="text-sm">Gunakan tombol "Muat ImgBB" untuk menambahkan foto</p>
      </div>
    </section>
  </main>
  
  <!-- Bottom Navigation for Mobile -->
  <div class="bottom-nav sm:hidden">
    <div class="flex justify-around">
      <button id="mobileLoadImgBB" class="flex flex-col items-center text-xs">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        <span>ImgBB</span>
      </button>
      <button id="mobileExport" class="flex flex-col items-center text-xs">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        <span>Ekspor</span>
      </button>
      <button id="mobileImport" class="flex flex-col items-center text-xs">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
        </svg>
        <span>Impor</span>
      </button>
    </div>
  </div>

  <!-- Viewer Modal -->
  <div id="viewer" class="fixed inset-0 hidden place-items-center bg-black/80 p-4 z-50">
    <div class="relative w-full h-full flex flex-col">
      <button id="viewerClose" class="absolute top-4 right-4 px-4 py-2 rounded-lg bg-white/10 z-10">Tutup</button>
      <div class="flex-1 overflow-hidden flex items-center justify-center mt-4">
        <img id="viewerImg" src="" alt="" class="max-w-full max-h-full object-contain" />
      </div>
      <div class="mt-3 flex justify-between items-center bg-[var(--card)] p-3 rounded-lg">
        <div class="text-sm text-white/70 flex-1 truncate" id="viewerMeta"></div>
        <div class="flex gap-2 ml-2">
          <button id="btnDownload" class="px-3 py-2 text-sm rounded-xl bg-white/5 border border-white/10">Unduh</button>
          <button id="btnDelete" class="px-3 py-2 text-sm rounded-xl bg-rose-600 hover:bg-rose-500">Hapus</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Key Modal -->
  <div id="keyModal" class="modal">
    <div class="modal-content">
      <h2 id="keyModalTitle" class="text-lg font-bold mb-4">Masukkan Kunci Akses</h2>
      <p id="keyModalDesc" class="text-sm text-white/70 mb-3">Untuk melanjutkan operasi ini, masukkan kunci akses yang sesuai.</p>
      <input type="password" id="keyInput" placeholder="Masukkan kunci..." class="input-android w-full bg-white/5 border border-white/10 outline-none focus:ring-2 focus:ring-violet-500 mb-4" />
      <div class="flex justify-end gap-2">
        <button id="keyCancel" class="btn-android bg-white/5 hover:bg-white/10 border border-white/10">Batal</button>
        <button id="keySubmit" class="btn-android bg-violet-600 hover:bg-violet-500">Submit</button>
      </div>
    </div>
  </div>

  <!-- ImgBB URL Input Modal -->
  <div id="imgbbModal" class="modal">
    <div class="modal-content">
      <h2 class="text-lg font-bold mb-4">Tambah Foto dari ImgBB</h2>
      <p class="text-sm text-white/70 mb-3">Masukkan URL gambar ImgBB (satu per baris):</p>
      <textarea id="imgbbUrls" placeholder="https://i.ibb.co/abc123/photo1.jpg&#10;https://i.ibb.co/def456/photo2.jpg" class="input-android w-full bg-white/5 border border-white/10 outline-none focus:ring-2 focus:ring-violet-500 mb-4" rows="10"></textarea>
      <div class="flex justify-end gap-2">
        <button id="imgbbCancel" class="btn-android bg-white/5 hover:bg-white/10 border border-white/10">Batal</button>
        <button id="imgbbSubmit" class="btn-android bg-green-600 hover:bg-green-500">Tambah</button>
      </div>
    </div>
  </div>

  <!-- Templates -->
  <template id="cardTemplate">
    <article class="group relative overflow-hidden rounded-2xl bg-[var(--card)] border border-white/10 shadow-soft hover:border-violet-500/40">
      <img class="w-full h-40 object-cover select-none img-loading" draggable="false" onerror="handleImageError(this)" onload="handleImageLoad(this)" />
      <div class="p-3 flex items-center gap-2">
        <input class="title flex-1 bg-transparent outline-none border-b border-transparent focus:border-white/20 text-sm" placeholder="Nama foto" />
        <span class="text-[10px] text-[var(--muted)] whitespace-nowrap date"></span>
      </div>
      <div class="px-3 pb-3">
        <textarea class="notes w-full resize-none bg-white/5 rounded-lg p-2 text-xs" rows="2" placeholder="Catatanâ€¦"></textarea>
      </div>
      <div class="absolute inset-0 hidden group-hover:flex items-center justify-center bg-black/40">
        <button class="view px-3 py-2 rounded-xl bg-white/10 border border-white/20">Lihat</button>
      </div>
    </article>
  </template>

  <input id="importInput" type="file" accept="application/zip" class="hidden" />

  <script>
    // Fungsi untuk menangani error gambar
    function handleImageError(img) {
      console.error('Gagal memuat gambar:', img.src);
      img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiBmaWxsPSIjMkMzRTUwIi8+Cjx0ZXh0IHg9Ijc1IiB5PSI4MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+R2FtYmFyIFRpZGFrIFRlcnNlZGlhPC90ZXh0Pgo8L3N2Zz4=';
      img.parentNode.classList.add('image-error');
      img.classList.remove('img-loading');
    }

    // Fungsi untuk menangani gambar berhasil dimuat
    function handleImageLoad(img) {
      img.classList.remove('img-loading');
    }

    // Fungsi untuk memperbaiki URL ImgBB
    function fixImgBBUrl(url) {
      if (!url) return '';
      
      // Pastikan URL menggunakan format yang benar
      if (url.includes('i.ibb.co.com')) {
        url = url.replace('i.ibb.co.com', 'i.ibb.co');
      }
      
      // Pastikan URL menggunakan HTTPS
      if (url.startsWith('http://')) {
        url = url.replace('http://', 'https://');
      }
      
      // Hapus parameter yang tidak perlu
      if (url.includes('?')) {
        url = url.split('?')[0];
      }
      
      return url;
    }

    // Fungsi untuk memeriksa apakah gambar dapat diakses
    async function checkImageAccessibility(url) {
      return new Promise((resolve) => {
        if (!url) {
          resolve(false);
          return;
        }
        
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        img.src = url;
        
        // Timeout setelah 5 detik
        setTimeout(() => resolve(false), 5000);
      });
    }

    // === Utility: IndexedDB minimal wrapper ===
    const DB_NAME = 'trickster_memory';
    const STORE = 'photos';
    const UPLOAD_KEY = 'TRICKSTERBACKERA';
    const DOWNLOAD_DELETE_KEY = 'ARCELGANTENG';
    
    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 2); // Increased version number
        req.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (event.oldVersion < 1) {
            // Initial creation
            const store = db.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
            store.createIndex('createdAt', 'createdAt');
            store.createIndex('title', 'title');
          }
          if (event.oldVersion < 2) {
            // Added in version 2: source field for ImgBB images
            const transaction = event.target.transaction;
            const store = transaction.objectStore(STORE);
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    function tx(db, mode='readonly') { return db.transaction(STORE, mode).objectStore(STORE); }
    
    async function addPhoto(record) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const req = tx(db, 'readwrite').add(record);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    
    async function getAll() {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const req = tx(db).getAll();
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    
    async function updatePhoto(id, patch) {
      const db = await openDB();
      const store = tx(db, 'readwrite');
      const current = await new Promise((res, rej)=>{ const r = store.get(id); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });
      Object.assign(current, patch);
      return new Promise((resolve, reject) => { const r = store.put(current); r.onsuccess=()=>resolve(); r.onerror=()=>reject(r.error); });
    }
    
    async function deletePhoto(id) {
      const db = await openDB();
      return new Promise((resolve, reject)=>{ const r = tx(db, 'readwrite').delete(id); r.onsuccess=()=>resolve(); r.onerror=()=>reject(r.error); });
    }
    
    async function clearAll() { const db = await openDB(); return new Promise((res,rej)=>{ const r = tx(db,'readwrite').clear(); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }

    // === DOM refs ===
    const gallery = document.getElementById('gallery');
    const search = document.getElementById('search');
    const sort = document.getElementById('sort');
    const viewer = document.getElementById('viewer');
    const viewerImg = document.getElementById('viewerImg');
    const viewerMeta = document.getElementById('viewerMeta');
    const viewerClose = document.getElementById('viewerClose');
    const btnDelete = document.getElementById('btnDelete');
    const btnDownload = document.getElementById('btnDownload');
    const btnClear = document.getElementById('btnClear');
    const btnExport = document.getElementById('btnExport');
    const btnImport = document.getElementById('btnImport');
    const btnLoadImgBB = document.getElementById('btnLoadImgBB');
    const importInput = document.getElementById('importInput');
    const keyModal = document.getElementById('keyModal');
    const keyModalTitle = document.getElementById('keyModalTitle');
    const keyModalDesc = document.getElementById('keyModalDesc');
    const keyInput = document.getElementById('keyInput');
    const keyCancel = document.getElementById('keyCancel');
    const keySubmit = document.getElementById('keySubmit');
    const mobileExport = document.getElementById('mobileExport');
    const mobileImport = document.getElementById('mobileImport');
    const mobileLoadImgBB = document.getElementById('mobileLoadImgBB');
    const imgbbModal = document.getElementById('imgbbModal');
    const imgbbUrls = document.getElementById('imgbbUrls');
    const imgbbCancel = document.getElementById('imgbbCancel');
    const imgbbSubmit = document.getElementById('imgbbSubmit');

    let allPhotos = [];
    let currentId = null;
    let isUploadAuthenticated = false;
    let isDownloadDeleteAuthenticated = false;
    let pendingAction = null;
    let pendingFiles = null;

    function fmtDate(ms){ 
      const d = new Date(ms); 
      return d.toLocaleDateString('id-ID', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric' 
      }); 
    }

    // Render functions
    async function render() {
      const q = search.value.trim().toLowerCase();
      let items = [...allPhotos];
      if (q) items = items.filter(p => (p.title||'').toLowerCase().includes(q) || (p.notes||'').toLowerCase().includes(q));
      if (sort.value === 'newest') items.sort((a,b)=>b.createdAt-a.createdAt);
      else if (sort.value === 'oldest') items.sort((a,b)=>a.createdAt-b.createdAt);
      else if (sort.value === 'name') items.sort((a,b)=> (a.title||'').localeCompare(b.title||''));

      gallery.innerHTML = '';
      
      if (items.length === 0) {
        gallery.innerHTML = `
          <div class="empty-state col-span-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <h3 class="text-lg font-medium mb-2">Belum ada foto</h3>
            <p class="text-sm">Gunakan tombol "Muat ImgBB" untuk menambahkan foto</p>
          </div>
        `;
        return;
      }

      const tpl = document.getElementById('cardTemplate');
      
      for (const p of items) {
        const node = tpl.content.firstElementChild.cloneNode(true);
        const img = node.querySelector('img');
        const title = node.querySelector('.title');
        const notes = node.querySelector('.notes');
        const date = node.querySelector('.date');
        const viewBtn = node.querySelector('.view');

        // Handle both Blob objects and external URLs
        if (p.blob) {
          // Create object URL for blob images
          try {
            const blobUrl = URL.createObjectURL(p.blob);
            img.src = blobUrl;
          } catch (error) {
            console.error('Error creating blob URL:', error);
            handleImageError(img);
          }
        } else if (p.url) {
          // Perbaiki URL ImgBB
          const fixedUrl = fixImgBBUrl(p.url);
          
          // Periksa apakah gambar dapat diakses
          const isAccessible = await checkImageAccessibility(fixedUrl);
          
          if (isAccessible) {
            img.src = fixedUrl;
          } else {
            // Jika tidak dapat diakses, gunakan placeholder
            handleImageError(img);
          }
        } else {
          // Jika tidak ada blob atau URL, tampilkan error
          handleImageError(img);
        }
        
        img.alt = p.title || 'Foto';
        date.textContent = fmtDate(p.createdAt);
        title.value = p.title || '';
        notes.value = p.notes || '';

        title.addEventListener('change', async ()=>{ 
          try {
            await updatePhoto(p.id, { title: title.value }); 
            p.title = title.value; 
          } catch (error) {
            console.error('Error updating title:', error);
          }
        });
        
        notes.addEventListener('change', async ()=>{ 
          try {
            await updatePhoto(p.id, { notes: notes.value }); 
            p.notes = notes.value; 
          } catch (error) {
            console.error('Error updating notes:', error);
          }
        });
        
        viewBtn.addEventListener('click', ()=> openViewer(p));

        gallery.appendChild(node);
      }
    }

    function openViewer(p){
      currentId = p.id;
      
      // Handle both Blob objects and external URLs
      if (p.blob) {
        try {
          const blobUrl = URL.createObjectURL(p.blob);
          viewerImg.src = blobUrl;
        } catch (error) {
          console.error('Error creating blob URL for viewer:', error);
          viewerImg.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiBmaWxsPSIjMkMzRTUwIi8+Cjx0ZXh0IHg9Ijc1IiB5PSI4MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+R2FtYmFyIFRpZGFrIFRlcnNlZGlhPC90ZXh0Pgo8L3N2Zz4=';
        }
      } else if (p.url) {
        // Perbaiki URL ImgBB
        const fixedUrl = fixImgBBUrl(p.url);
        viewerImg.src = fixedUrl;
      } else {
        viewerImg.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiBmaWxsPSIjMkMzRTUwIi8+Cjx0ZXh0IHg9Ijc1IiB5PSI4MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1iZGRsZSI+R2FtYmFyIFRpZGFrIFRlcnNlZGlhPC90ZXh0Pgo8L3N2Zz4=';
      }
      
      viewerMeta.textContent = `${p.title||'Tanpa Judul'} â€¢ ${fmtDate(p.createdAt)}`;
      viewer.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeViewer(){ 
      viewer.classList.add('hidden'); 
      // Clean up blob URLs to prevent memory leaks
      if (viewerImg.src.startsWith('blob:')) {
        URL.revokeObjectURL(viewerImg.src);
      }
      viewerImg.src = ''; 
      currentId = null; 
      document.body.style.overflow = '';
    }

    // Authentication functions
    function showKeyModal(actionType) {
      pendingAction = actionType;
      
      if (actionType === 'upload') {
        keyModalTitle.textContent = 'Kunci Unggah';
        keyModalDesc.textContent = 'Masukkan kunci untuk mengunggah foto.';
      } else if (actionType === 'download-delete') {
        keyModalTitle.textContent = 'Kunci Unduh/Hapus';
        keyModalDesc.textContent = 'Masukkan kunci untuk mengunduh atau menghapus foto.';
      }
      
      keyModal.style.display = 'block';
      keyInput.value = '';
      keyInput.focus();
      document.body.style.overflow = 'hidden';
    }

    function hideKeyModal() {
      keyModal.style.display = 'none';
      document.body.style.overflow = '';
    }

    function verifyKey() {
      let isValid = false;
      
      if (pendingAction === 'upload' && keyInput.value === UPLOAD_KEY) {
        isUploadAuthenticated = true;
        isValid = true;
      } else if (pendingAction === 'download-delete' && keyInput.value === DOWNLOAD_DELETE_KEY) {
        isDownloadDeleteAuthenticated = true;
        isValid = true;
      }
      
      if (isValid) {
        hideKeyModal();
        if (pendingAction === 'download-delete') {
          executePendingDownloadDeleteAction();
        }
        return true;
      } else {
        alert('Kunci akses salah!');
        keyInput.value = '';
        keyInput.focus();
        return false;
      }
    }

    // ImgBB functions
    function showImgBBModal() {
      imgbbModal.style.display = 'block';
      imgbbUrls.value = '';
      imgbbUrls.focus();
      document.body.style.overflow = 'hidden';
    }

    function hideImgBBModal() {
      imgbbModal.style.display = 'none';
      document.body.style.overflow = '';
    }

    async function addImgBBPhotos() {
      const urls = imgbbUrls.value.split('\n')
        .map(url => url.trim())
        .filter(url => url.length > 0 && url.startsWith('http'));
      
      if (urls.length === 0) {
        alert('Masukkan setidaknya satu URL gambar yang valid!');
        return;
      }

      for (const url of urls) {
        // Extract filename from URL for title
        const urlParts = url.split('/');
        let filename = urlParts[urlParts.length - 1];
        filename = filename.split('?')[0];
        const title = filename.replace(/\.[^.]+$/, '');
        
        // Perbaiki URL ImgBB
        const imageUrl = fixImgBBUrl(url);
        
        // Periksa apakah gambar dapat diakses sebelum menyimpan
        const isAccessible = await checkImageAccessibility(imageUrl);
        
        if (!isAccessible) {
          alert(`Gambar tidak dapat diakses: ${imageUrl}. Pastikan URL benar dan gambar bersifat publik.`);
          continue;
        }
        
        // Create record with URL instead of blob
        const rec = { 
          title: title, 
          notes: 'Dari ImgBB', 
          createdAt: Date.now(), 
          url: imageUrl,
          source: 'imgbb' 
        };
        
        try {
          await addPhoto(rec);
        } catch (error) {
          console.error('Error adding photo:', error);
          alert('Terjadi kesalahan saat menambahkan foto. Silakan coba lagi.');
        }
      }
      
      allPhotos = await getAll();
      render();
      hideImgBBModal();
    }

    // Delete / Download
    let pendingDownloadDeleteAction = null;

    btnDelete.addEventListener('click', async ()=>{
      if (!currentId) return;
      
      if (!isDownloadDeleteAuthenticated) {
        pendingDownloadDeleteAction = 'delete';
        showKeyModal('download-delete');
      } else {
        executeDelete();
      }
    });

    btnDownload.addEventListener('click', async ()=>{
      if (!currentId) return;
      
      if (!isDownloadDeleteAuthenticated) {
        pendingDownloadDeleteAction = 'download';
        showKeyModal('download-delete');
      } else {
        executeDownload();
      }
    });

    function executePendingDownloadDeleteAction() {
      if (pendingDownloadDeleteAction === 'delete') {
        executeDelete();
      } else if (pendingDownloadDeleteAction === 'download') {
        executeDownload();
      }
      pendingDownloadDeleteAction = null;
    }

    async function executeDelete() {
      try {
        await deletePhoto(currentId);
        allPhotos = await getAll();
        render();
        closeViewer();
      } catch (error) {
        console.error('Error deleting photo:', error);
        alert('Terjadi kesalahan saat menghapus foto. Silakan coba lagi.');
      }
    }

    async function executeDownload() {
      const p = allPhotos.find(x=>x.id===currentId);
      if (!p) return;
      
      if (p.url) {
        try {
          const imageUrl = fixImgBBUrl(p.url);
          const response = await fetch(imageUrl);
          const blob = await response.blob();
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = (p.title||'photo') + '.jpg';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          // Clean up URL
          setTimeout(() => URL.revokeObjectURL(a.href), 100);
        } catch (error) {
          console.error('Error downloading external image:', error);
          alert('Gagal mengunduh gambar. Silakan coba lagi.');
        }
      } else if (p.blob) {
        try {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(p.blob);
          a.download = (p.title||'photo') + '.jpg';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          // Clean up URL
          setTimeout(() => URL.revokeObjectURL(a.href), 100);
        } catch (error) {
          console.error('Error downloading blob image:', error);
          alert('Gagal mengunduh gambar. Silakan coba lagi.');
        }
      }
    }

    viewerClose.addEventListener('click', closeViewer);
    viewer.addEventListener('click', (e)=>{ if (e.target===viewer) closeViewer(); });

    // Search & Sort
    search.addEventListener('input', () => render());
    sort.addEventListener('change', () => render());

    // Clear all
    btnClear.addEventListener('click', async ()=>{
      if (!isDownloadDeleteAuthenticated) {
        pendingDownloadDeleteAction = 'clear-all';
        showKeyModal('download-delete');
      } else {
        executeClearAll();
      }
    });

    async function executeClearAll() {
      if (!confirm('Hapus semua foto di album ini dari perangkat ini?')) return;
      try {
        await clearAll();
        allPhotos = [];
        render();
      } catch (error) {
        console.error('Error clearing all photos:', error);
        alert('Terjadi kesalahan saat menghapus semua foto. Silakan coba lagi.');
      }
    }

    // Export to ZIP (client-side)
    function exportZip() {
      if (allPhotos.length === 0) {
        alert('Tidak ada foto untuk diekspor!');
        return;
      }
      
      if (!isDownloadDeleteAuthenticated) {
        pendingDownloadDeleteAction = 'export';
        showKeyModal('download-delete');
      } else {
        executeExportZip();
      }
    }

    async function executeExportZip() {
      try {
        const { default: JSZip } = await import('https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm');
        const zip = new JSZip();
        
        for (const p of allPhotos){
          let blob;
          
          if (p.blob) {
            blob = p.blob;
          } else if (p.url) {
            try {
              const imageUrl = fixImgBBUrl(p.url);
              const response = await fetch(imageUrl);
              blob = await response.blob();
            } catch (error) {
              console.error('Error fetching external image:', error);
              continue;
            }
          } else {
            continue;
          }
          
          const buf = await blob.arrayBuffer();
          const name = (p.title||('photo_'+p.id)).replace(/[^a-z0-9_\-]+/gi,'_') + '.jpg';
          zip.file(name, buf);
        }
        
        const blob = await zip.generateAsync({ type: 'blob' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'TRICKSTER_MEMORY.zip';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        // Clean up URL
        setTimeout(() => URL.revokeObjectURL(a.href), 100);
      } catch (error) {
        console.error('Error exporting zip:', error);
        alert('Terjadi kesalahan saat mengekspor foto. Silakan coba lagi.');
      }
    }

    btnExport.addEventListener('click', exportZip);
    mobileExport.addEventListener('click', exportZip);

    // Import from ZIP (names become titles)
    function importZip() {
      importInput.click();
    }

    btnImport.addEventListener('click', importZip);
    mobileImport.addEventListener('click', importZip);
    
    importInput.addEventListener('change', async ()=>{
      const file = importInput.files[0]; 
      if (!file) return;
      
      if (!isUploadAuthenticated) {
        pendingFiles = file;
        showKeyModal('upload');
        return;
      }
      
      try {
        const { default: JSZip } = await import('https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm');
        const zip = await JSZip.loadAsync(file);
        let addedCount = 0;
        
        for (const [path, entry] of Object.entries(zip.files)){
          if (entry.dir) continue;
          const ext = path.split('.').pop().toLowerCase();
          if (!['png','jpg','jpeg','webp','gif'].includes(ext)) continue;
          
          try {
            const blob = new Blob([await entry.async('arraybuffer')], { type: `image/${ext==='jpg'?'jpeg':ext}` });
            await addPhoto({ title: path.replace(/\.[^.]+$/, ''), notes:'', createdAt: Date.now(), blob });
            addedCount++;
          } catch (error) {
            console.error('Error adding photo from zip:', error, path);
          }
        }
        
        allPhotos = await getAll();
        render();
        importInput.value = '';
        
        if (addedCount > 0) {
          alert(`Berhasil menambahkan ${addedCount} foto dari file ZIP.`);
        } else {
          alert('Tidak ada foto yang dapat ditambahkan dari file ZIP.');
        }
      } catch (error) {
        console.error('Error importing zip:', error);
        alert('Terjadi kesalahan saat mengimpor file ZIP. Silakan coba lagi.');
      }
    });

    // Key modal event handlers
    keySubmit.addEventListener('click', verifyKey);
    keyCancel.addEventListener('click', hideKeyModal);
    keyInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') verifyKey();
    });

    // ImgBB modal event handlers
    imgbbSubmit.addEventListener('click', addImgBBPhotos);
    imgbbCancel.addEventListener('click', hideImgBBModal);
    imgbbUrls.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && e.ctrlKey) {
        addImgBBPhotos();
      }
    });

    // Load ImgBB button handlers
    btnLoadImgBB.addEventListener('click', showImgBBModal);
    mobileLoadImgBB.addEventListener('click', showImgBBModal);

    // Initial load
    (async ()=>{ 
      try {
        allPhotos = await getAll(); 
        await render(); 
      } catch (error) {
        console.error('Error during initial load:', error);
        gallery.innerHTML = `
          <div class="empty-state col-span-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.966-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
            </svg>
            <h3 class="text-lg font-medium mb-2">Terjadi Kesalahan</h3>
            <p class="text-sm">Gagal memuat foto. Silakan refresh halaman.</p>
          </div>
        `;
      }
    })();
  </script>
</body>
            </html>
